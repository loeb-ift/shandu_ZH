以下是您提供的內容轉換成 Markdown 格式的版本，已進行適當的格式化以增強可讀性：

```markdown
# 生成查詢節點 (Generate Queries Node) 詳細說明

在 Shandu 研究系統中，生成查詢節點是研究工作流程中的關鍵組件，它負責將高層次的研究計劃轉化為具體的搜索查詢。根據您提到的四個主要功能，我將詳細解釋每個功能的實現方式。

## 1. 分析當前研究狀態和研究計劃

生成查詢節點首先會分析 AgentState 中的當前研究狀態，包括：

- 研究計劃（由初始化節點生成）
- 當前的研究發現（findings）
- 已執行的查詢和結果
- 反思節點產生的知識缺口（knowledge gaps）

這個分析過程主要通過檢查 `state["findings"]` 來了解目前的研究進展，並識別需要進一步探索的領域。

在 `ResearchAgent` 類中，我們可以看到這種分析是如何實現的：`agent.py:95-99`

## 2. 識別需要調查的關鍵領域

基於對當前研究狀態的分析，生成查詢節點會識別需要深入調查的關鍵領域。這些關鍵領域通常來自：

- 初始化節點生成的研究計劃中的 "Key Areas to Investigate" 部分
- 反思節點識別的知識缺口
- 當前研究發現中未充分探索的方面

系統使用 LLM 來分析這些信息並確定優先調查的領域，特別是在迭代深入研究過程中。

## 3. 生成針對這些領域的具體搜索查詢

這是生成查詢節點的核心功能。節點會為每個識別出的關鍵領域生成具體、有針對性的搜索查詢。這些查詢被設計為：

- 足夠具體，以獲取相關信息
- 使用自然語言，適合搜索引擎處理
- 涵蓋不同角度，以獲得全面的結果

在 `ResearchAgent` 類中，我們可以看到查詢生成的實現：`agent.py:100-111`

這個過程使用了一個專門的提示模板 `query_gen_prompt`，該模板指導 LLM 生成有效的搜索查詢。在 `prompts.py` 中，我們可以看到這個提示的設計：`prompts.py:71-77`

這個提示強調查詢應該：

- 使用日常語言，避免過於學術或正式的措辭
- 簡潔但精確地定位所需信息
- 避免任何多餘的格式或標籤
- 提供直接、自然的查詢，就像真人會輸入到搜索引擎的那種

## 4. 將生成的查詢添加到狀態中

生成的查詢會被添加到 `AgentState` 對象的 `subqueries` 列表中，以便後續的搜索節點使用。這個過程確保了：

- 所有生成的查詢都被追踪
- 查詢可以按照生成的順序或優先級處理
- 系統可以避免重複查詢
- 研究過程的完整記錄被維護

在 `ResearchAgent` 類中，我們可以看到這是如何實現的：`agent.py:209-214`

## 查詢生成與搜索的集成

生成的查詢直接傳遞給搜索節點，搜索節點會使用這些查詢來獲取信息：`search.py:54-58`

搜索節點會處理最近生成的查詢（基於設定的廣度參數），如果沒有子查詢，則使用原始查詢：`search.py:71-76`

## 查詢生成的迭代過程

在 Shandu 研究系統中，查詢生成是一個迭代過程。初始查詢基於研究計劃生成，但隨著研究的深入，系統會基於新發現和反思生成更具體、更有針對性的查詢。

在 `ResearchAgent` 的研究方法中，我們可以看到這個迭代過程：`agent.py:205-214`

每次迭代都會：

- 反思當前的研究發現
- 生成新的子查詢
- 將這些查詢添加到狀態中
- 執行這些查詢並分析結果

## 實際執行流程

當用戶通過 CLI 啟動研究過程時，整個流程會自動執行：`cli.py:363-404`

系統會創建 `ResearchGraph` 並執行研究，其中包括查詢生成和搜索的迭代過程。進度回調函數 `debounced_update_display` 會追踪狀態變化，包括子查詢的數量，並更新顯示。

## 總結

生成查詢節點是 Shandu 研究系統中的關鍵組件，它將高層次的研究計劃轉化為具體的搜索查詢。通過分析當前研究狀態、識別關鍵領域、生成具體查詢並將它們添加到狀態中，這個節點使系統能夠進行深入、全面的研究。查詢生成是一個迭代過程，隨著研究的深入，系統會生成越來越具體、有針對性的查詢，從而獲得更相關、更全面的信息。

## Notes

本回答詳細解釋了 Shandu 研究系統中生成查詢節點的四個主要功能。雖然代碼庫中沒有直接顯示名為 `gen_queries` 的節點實現，但我基於 `ResearchAgent` 類中的相關方法和 `prompts.py` 中的提示模板解釋了查詢生成的過程。這些代碼片段展示了系統如何分析研究狀態、識別關鍵領域、生成查詢並將它們添加到狀態中。

值得注意的是，Shandu 系統使用 LangGraph 狀態圖來管理研究工作流程，其中查詢生成是一個關鍵節點，它連接初始化節點和搜索節點，並與反思節點形成迭代循環。
```

您可以將上述 Markdown 內容複製並粘貼到支持 Markdown 格式的編輯器中，以查看其效果。
